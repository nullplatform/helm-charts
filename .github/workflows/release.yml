name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  changelog:
    uses: nullplatform/actions-nullplatform/.github/workflows/changelog-release.yml@main
    with:
      project-type: helm-charts
      source-dir: charts
      create-github-release: false
      commit-message: 'chore(release): bump version and update changelog [skip ci]'
    permissions:
      contents: write

  package-and-publish:
    needs: changelog
    if: needs.changelog.outputs.has_changes == 'true'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pages: write
      id-token: write
    concurrency:
      group: "pages"
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin ${GITHUB_REF#refs/heads/}

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Set up Helm
        run: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Detect changed charts
        id: detect-changes
        run: |
          # Find charts that were modified in the last commit (the changelog commit)
          changed=$(git diff --name-only HEAD~1 -- charts/ | awk -F/ '/^charts\/[^/]+/ {print $1"/"$2}' | sort -u)
          if [ -z "$changed" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "$changed" > .changed-charts

          # Generate tags from Chart.yaml
          while read -r dir; do
            name=$(awk -F': *' '$1=="name"{print $2; exit}' "$dir/Chart.yaml")
            version=$(awk -F': *' '$1=="version"{print $2; exit}' "$dir/Chart.yaml")
            echo "${name}-${version}" >> .chart-tags
          done < .changed-charts

      - name: Install helm-docs
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          curl -sSL https://github.com/norwoodj/helm-docs/releases/download/v1.14.2/helm-docs_1.14.2_Linux_x86_64.tar.gz -o /tmp/helm-docs.tgz
          tar -xzf /tmp/helm-docs.tgz -C /tmp
          mkdir -p "$HOME/bin"
          mv /tmp/helm-docs "$HOME/bin/helm-docs"
          echo "$HOME/bin" >> "$GITHUB_PATH"

      - name: Update chart README files
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: ./scripts/run-helm-docs.sh

      - name: Update root README
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: ./scripts/generate-root-readme.sh

      - name: Package changed charts
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          mkdir -p ./releases
          while read -r dir; do
            helm dependency update "$dir"
            helm package "$dir" -d ./releases
          done < .changed-charts

      - name: Generate Helm repository index
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: helm repo index ./releases --url https://nullplatform.github.io/helm-charts

      - name: Push changes and tags
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          git add charts releases README.md
          if ! git diff --cached --quiet; then
            git commit -m "ci: publish chart releases [skip ci]"
            git push origin ${GITHUB_REF#refs/heads/}
          fi

          # Create and push tags
          while read -r tag; do
            if ! git rev-parse "$tag" >/dev/null 2>&1; then
              git tag "$tag"
            fi
          done < .chart-tags
          git push origin --tags

      - name: Setup Pages
        if: steps.detect-changes.outputs.has_changes == 'true'
        uses: actions/configure-pages@v5

      - name: Upload artifact
        if: steps.detect-changes.outputs.has_changes == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: './releases'

      - name: Deploy to GitHub Pages
        if: steps.detect-changes.outputs.has_changes == 'true'
        uses: actions/deploy-pages@v4
