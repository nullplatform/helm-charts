name: Release Charts

on:
  push:
    branches:
      - main
      - master
jobs:
  package-and-publish-charts:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
      pages: write
    concurrency:
      group: "pages"
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Git Identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
      - name: Set up Helm
        run: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - name: Prepare chart release
        id: chart-release
        env:
          BASE_SHA: ${{ github.event.before }}
          HEAD_SHA: ${{ github.sha }}
        run: ./scripts/prepare-chart-release.sh
      - name: Install helm-docs
        if: steps.chart-release.outputs.has_changes == 'true'
        run: |
          curl -sSL https://github.com/norwoodj/helm-docs/releases/download/v1.14.2/helm-docs_1.14.2_Linux_x86_64.tar.gz -o /tmp/helm-docs.tgz
          tar -xzf /tmp/helm-docs.tgz -C /tmp
          mkdir -p "$HOME/bin"
          mv /tmp/helm-docs "$HOME/bin/helm-docs"
          echo "$HOME/bin" >> "$GITHUB_PATH"
      - name: Update chart README files
        if: steps.chart-release.outputs.has_changes == 'true'
        run: ./scripts/run-helm-docs.sh
      - name: Update root README
        if: steps.chart-release.outputs.has_changes == 'true'
        run: ./scripts/generate-root-readme.sh
      - name: Package changed charts
        if: steps.chart-release.outputs.has_changes == 'true'
        run: |
          while read -r dir; do
            helm dependency update "$dir"
            helm package "$dir" -d ./releases
          done < .changed-charts
      - name: Generate Helm repository index in releases directory
        if: steps.chart-release.outputs.has_changes == 'true'
        run: helm repo index ./releases --url https://nullplatform.github.io/helm-charts
      - name: Push changes to GitHub
        if: steps.chart-release.outputs.has_changes == 'true'
        run: |
          git add charts releases README.md
          if ! git diff --cached --quiet; then
            git commit -m "ci: publish chart releases [ci skip]"
            git push origin ${GITHUB_REF#refs/heads/}
          fi
          while read -r tag; do
            if git rev-parse "$tag" >/dev/null 2>&1; then
              continue
            fi
            git tag "$tag"
          done < .chart-tags
          git push origin --tags
      - name: Setup Pages
        if: steps.chart-release.outputs.has_changes == 'true'
        uses: actions/configure-pages@v5
      - name: Upload artifact
        if: steps.chart-release.outputs.has_changes == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: './releases'
      - name: Deploy to GitHub Pages
        if: steps.chart-release.outputs.has_changes == 'true'
        uses: actions/deploy-pages@v4
