replicaCount: 1

# Workload type: "deployment" or "statefulset"
workloadType: deployment

# StatefulSet specific configuration (only used when workloadType is "statefulset")
statefulset:
  # Service name for StatefulSet (required for StatefulSet)
  serviceName: nullplatform-agent
  # Pod Management Policy: "OrderedReady" or "Parallel"
  podManagementPolicy: OrderedReady
  # Update strategy
  updateStrategy:
    type: RollingUpdate
  # Persistent Volume Claims for StatefulSet
  # volumeClaimTemplates: []
  # Example:
  # volumeClaimTemplates:
  #   - metadata:
  #       name: data
  #     spec:
  #       accessModes: [ "ReadWriteOnce" ]
  #       storageClassName: "standard"
  #       resources:
  #         requests:
  #           storage: 1Gi
  volumeClaimTemplates: []

namespace: nullplatform-tools

args:
  - "--tags=$(TAGS)"
  - "--apikey=$(NP_API_KEY)"
  - "--runtime=host"
  - "--command-executor-env=NP_API_KEY=$(NP_API_KEY)"
  - "--command-executor-debug"
  - "--webserver-enabled"
  - "--command-executor-git-command-repos $(AGENT_REPO)"

configuration:
  create: true
  secretName: nullplatform-agent-secret
  values:
    TAGS: ""
    NP_LOG_LEVEL: DEBUG
    NP_API_KEY: ""
      #example:
    #AGENT_REPO: "https://reppo_01.gt#main,https://token@repo_01.git#main"
    AGENT_REPO: ""

image:
  repository: public.ecr.aws/nullplatform/controlplane-agent
  pullPolicy: Always
  tag: latest

nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: nullplatform-agent
  # Set to true for cluster-wide access (ClusterRole), false for namespace-scoped access (Role)
  clusterWide: true
  role:
    rules:
      - apiGroups:
          - '*'
          - ""
        resources:
          - '*'
        verbs:
          - '*'

podAnnotations:
  name: nullplatform-agent
podLabels:
  name: nullplatform-agent

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

resources: {}

livenessProbe:
  httpGet:
    path: /health
    port: 8080
readinessProbe:
  httpGet:
    path: /health
    port: 8080

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations:
  - key: "node.kubernetes.io/not-ready"
    operator: "Exists"
    effect: "NoExecute"
    tolerationSeconds: 300
  - key: "node.kubernetes.io/unreachable"
    operator: "Exists"
    effect: "NoExecute"
    tolerationSeconds: 300

affinity: {}

priorityClass:
  enabled: true
  value: 500000

# Init containers to run before the main container
# Example:
# initContainers:
#   - name: install-dependencies
#     image: busybox:1.36
#     command: ['sh', '-c', 'echo "Installing dependencies..."']
#     volumeMounts:
#       - name: repos
#         mountPath: /root/.np
initContainers: []

# GitHub App Token Init Container Configuration
githubTokenInit:
  enabled: true
  image: alpine:3.22.2
  # Secret that contains GitHub App configuration
  secretName: "github-app-secret"
  # Keys in the secret for each value
  secretKeys:
    appId: "APP_ID"           # nombre de la clave en el secret
    installationId: "INSTALLATION_ID"
    privateKey: "PRIVATE_KEY"
  values:
    appId: ""
    installationId: ""
    privateKey: ""
 
  repositoryUrl: "github.com/packer-builder/scope.git"
  # Directory where the repository will be cloned (shared with main container)
  workingDir: "/root/.np"
  cloneDir: "nullplatform"

podSecurityContext:
  runAsUser: 0
  runAsNonRoot: false

volumes: []

initScripts: []

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []

#Lifecycle preStop Hook for Graceful Agent Shutdown
lifecycle:
  preStop:
    exec:
      command:
        - /bin/sh
        - -c
        - 'pid=$(pgrep -f agent) && kill -15 $pid && sleep 30'

# Image pull secret configuration
imagePullSecret:
  # Use an existing secret (recommended for production)
  # Set 'name' to reference an existing secret, leave create: false
  # OR
  # Create a new secret by setting create: true and providing credentials
  create: false
  # name: image-pull-secret-agent
  # registry: ""
  # username: ""
  # password: ""
